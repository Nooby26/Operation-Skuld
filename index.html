<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Steins;Gate Divergence Meter - Visual Novel Counter</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&family=Orbitron:wght@700&family=Courier+New&display=swap');

        :root {
            --primary-color: #ff6000;
            --secondary-color: #ff9d00;
            --dark-bg: #0a0500;
            --panel-bg: rgba(10, 5, 0, 0.9);
            --border-color: #ff8033;
            --font-main: 'VT323', 'Lucida Console', monospace;
            --font-cmd: 'VT323', 'Share Tech Mono', 'Courier New', monospace;
        }

        body, html {
            margin: 0; padding: 0;
            height: 100%;
            background: #000;
            font-family: var(--font-main);
            color: var(--primary-color);
            overflow: hidden;
            position: relative;
        }

        .main-container {
            height: 100vh;
            background: #000;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* Background image support */
        .main-container.has-background {
            background-image: url('background.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        /* Background glow overlay - OFF by default */
        .background-glow-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at 50% 30%, #2a1500 0%, #000000 80%);
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            z-index: 1;
        }

        .background-glow-overlay.active {
            opacity: 1;
        }

        /* AMADEUS-STYLE INITIALIZATION OVERLAY */
        .initialization-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            opacity: 1;
            transition: opacity 0.5s ease;
        }

        .initialization-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .init-text {
            font-family: 'Orbitron', monospace;
            color: var(--primary-color);
            font-size: 24px;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 0 0 10px var(--primary-color);
        }

        .init-progress {
            width: 300px;
            height: 4px;
            background: rgba(255, 96, 0, 0.3);
            border: 1px solid var(--primary-color);
            overflow: hidden;
            margin-bottom: 15px;
        }

        .init-progress-fill {
            height: 100%;
            background: var(--primary-color);
            width: 0%;
            transition: width 0.3s ease;
            box-shadow: 0 0 8px var(--primary-color);
        }

        .init-status {
            font-family: var(--font-main);
            color: var(--secondary-color);
            font-size: 16px;
            text-align: center;
            min-height: 20px;
        }

        /* CMD-STYLE STATUS ELEMENTS */
        .cmd-status-route {
            position: fixed;
            top: 20px;
            left: 20px;
            font-family: var(--font-cmd);
            color: #ffffff;
            font-size: 16px;
            z-index: 300;
            pointer-events: none;
            transition: all 0.3s ease;
        }

        .cmd-status-worldline {
            position: fixed;
            top: 20px;
            right: 20px;
            font-family: var(--font-cmd);
            color: #ffffff;
            font-size: 16px;
            z-index: 300;
            pointer-events: none;
            transition: all 0.3s ease;
        }

        .cmd-status-progress {
            position: fixed;
            bottom: 80px;
            right: 20px;
            font-family: var(--font-cmd);
            color: #ffffff;
            font-size: 14px;
            z-index: 300;
            pointer-events: none;
            transition: all 0.3s ease;
        }

        /* BOTTOM RIGHT BUTTON CLUSTER */
        .bottom-buttons {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 1px;
            z-index: 400;
        }

        .mini-button {
            width: 20px;
            height: 20px;
            background: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            font-family: var(--font-main);
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            text-shadow: 0 0 3px var(--primary-color);
            border-radius: 2px;
        }

        .mini-button:hover {
            border-color: var(--primary-color);
            box-shadow: 0 0 8px var(--primary-color);
            background: rgba(255, 96, 0, 0.1);
        }

        /* SCANNING LINES ANIMATION */
        .scanning-lines {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
            opacity: 0.3;
        }

        .scanning-lines::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--primary-color), transparent);
            animation: scanDown 4s linear infinite;
            opacity: 0.6;
        }

        .scanning-lines::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 2px;
            height: 100%;
            background: linear-gradient(180deg, transparent, var(--primary-color), transparent);
            animation: scanRight 6s linear infinite;
            opacity: 0.4;
        }

        @keyframes scanDown {
            0% { top: -2px; }
            100% { top: 100%; }
        }

        @keyframes scanRight {
            0% { left: -2px; }
            100% { left: 100%; }
        }

        /* PARTICLE EFFECTS */
        .particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 3;
            opacity: 0.4;
        }

        .particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: var(--secondary-color);
            border-radius: 50%;
            animation: float 8s linear infinite;
        }

        @keyframes float {
            0% { transform: translateY(100vh) translateX(0px); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-10px) translateX(50px); opacity: 0; }
        }

        /* MAIN CONTENT AREA - ADJUSTABLE POSITIONING */
        .content-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            padding: 20px;
            z-index: 2;
            position: relative;
        }

        .divergence-display {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 40px;
            min-height: 150px;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .divergence-display img {
            height: 130px;
            margin: 0 1px;
            transition: height 0.3s ease;
        }

        .fallback-digit {
            display: inline-block;
            width: 60px;
            height: 130px;
            background: linear-gradient(180deg, #2a1500 0%, #1a0d00 50%, #0d0700 100%);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            margin: 0 2px;
            line-height: 130px;
            text-align: center;
            font-size: 48px;
            font-weight: bold;
            color: var(--primary-color);
            text-shadow: 0 0 10px var(--primary-color);
        }

        /* IMPROVED DIALOGUE BOX WITH SPRITE ALIGNMENT FIX */
        #dialogueBox {
            position: fixed;
            bottom: 40px;
            left: 5%;
            width: 55%;
            height: 80px;
            background: rgba(10, 5, 0, 0.95);
            border: 2px solid var(--border-color);
            padding: 12px 15px;
            font-size: 18px;
            z-index: 200;
            opacity: 0;
            transition: all 0.5s ease;
            pointer-events: none;
            box-shadow: 0 0 8px var(--primary-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            overflow: visible;
        }

        #dialogueBox.with-sprites {
            width: 80%;
        }

        #dialogueBox.visible {
            opacity: 1;
        }

        .dialogue-char {
            font-weight: bold;
            color: var(--secondary-color);
            margin-right: 4px;
        }

        .dialogue-text-container {
            flex: 1;
            min-width: 0;
            overflow: hidden;
            line-height: 1.1;
            display: flex;
            align-items: center;
        }

        .character-sprite {
            width: auto;
            max-width: 250px;
            height: auto;
            max-height: none;
            margin-left: 15px;
            opacity: 0;
            transition: opacity 0.5s ease;
            flex-shrink: 0;
            align-self: flex-end;
            position: relative;
            bottom: 0px; /* Will be adjustable via settings */
        }

        .character-sprite.visible {
            opacity: 1;
        }

        /* DIALOGUE BOX POSITION VARIANTS */
        #dialogueBox.position-bottom-left {
            bottom: 40px; left: 5%; width: 55%;
        }
        #dialogueBox.position-bottom-left.with-sprites {
            width: 80%;
        }
        #dialogueBox.position-bottom-center {
            bottom: 40px; left: 50%; width: 55%;
            transform: translateX(-50%);
        }
        #dialogueBox.position-bottom-center.with-sprites {
            width: 80%;
        }
        #dialogueBox.position-bottom-right {
            bottom: 40px; right: 5%; width: 55%;
            left: auto;
        }
        #dialogueBox.position-bottom-right.with-sprites {
            width: 80%;
        }
        #dialogueBox.position-center {
            top: 50%; left: 50%; width: 55%;
            transform: translate(-50%, -50%);
            bottom: auto;
        }
        #dialogueBox.position-center.with-sprites {
            width: 80%;
        }
        #dialogueBox.position-top-center {
            top: 40px; left: 50%; width: 55%;
            transform: translateX(-50%);
            bottom: auto;
        }
        #dialogueBox.position-top-center.with-sprites {
            width: 80%;
        }

        /* BOTTOM SLIDING SETTINGS DRAWER */
        .settings-drawer {
            position: fixed;
            bottom: -90vh;
            left: 0;
            right: 0;
            height: 90vh;
            background: var(--panel-bg);
            border-top: 2px solid var(--border-color);
            box-shadow: 0 -10px 25px rgba(255, 102, 0, 0.3);
            z-index: 500;
            transition: bottom 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
            overflow-y: auto;
            padding: 20px;
            box-sizing: border-box;
        }

        .settings-drawer.active {
            bottom: 0;
        }

        .settings-drawer h3 {
            font-size: 28px;
            color: #ff8033;
            text-shadow: 0 0 5px #ff8033;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .settings-content {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .settings-group {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ff6000;
            border-radius: 8px;
            background: rgba(10, 5, 0, 0.3);
        }

        .settings-group h4 {
            color: #ff9d00;
            font-size: 18px;
            margin: 0 0 15px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid #ff8033;
        }

        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 12px 0;
            font-size: 16px;
            text-align: left;
        }

        .setting-item label {
            flex: 1;
            margin-right: 10px;
            display: block;
        }

        .setting-item input[type="range"] {
            flex: 2;
            margin: 0 10px;
        }

        .setting-item input[type="number"], .setting-item select {
            flex: 1;
            margin-left: 10px;
        }

        .setting-item .value-display {
            min-width: 70px;
            text-align: right;
            color: #ff9d00;
            font-weight: bold;
            font-size: 14px;
        }

        /* FORM ELEMENTS STYLING */
        select, input[type="number"] {
            background: var(--dark-bg);
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            padding: 8px 12px;
            font-family: var(--font-main);
            font-size: 18px;
            width: 100%;
            box-sizing: border-box;
            border-radius: 3px;
        }

        input[type="range"] {
            -webkit-appearance: none; appearance: none;
            width: 100%; height: 5px; background: var(--primary-color);
            outline: none; border-radius: 3px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 25px; height: 25px; background: var(--secondary-color);
            cursor: pointer; border: 3px solid var(--dark-bg);
            box-shadow: 0 0 10px var(--secondary-color);
            border-radius: 50%;
        }

        input[type="checkbox"] {
            width: 20px; height: 20px;
            accent-color: var(--primary-color);
            margin-right: 8px;
        }

        textarea {
            background: var(--dark-bg);
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            padding: 10px;
            font-family: var(--font-main);
            font-size: 16px;
            width: 100%;
            box-sizing: border-box;
            border-radius: 3px;
            resize: vertical;
            min-height: 120px;
        }

        textarea::placeholder {
            color: #ff9d0070;
            font-style: italic;
        }

        .dialogue-editor {
            width: 100%;
            text-align: left;
        }

        .dialogue-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .dialogue-tab {
            padding: 8px 12px;
            font-size: 14px;
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--secondary-color);
            cursor: pointer;
            border-radius: 3px 3px 0 0;
            transition: all 0.3s;
        }

        .dialogue-tab.active {
            background: var(--secondary-color);
            color: #000;
        }

        .dialogue-tab:hover:not(.active) {
            background: rgba(255, 157, 0, 0.2);
        }

        .dialogue-content {
            display: none;
        }

        .dialogue-content.active {
            display: block;
        }

        .dialogue-help {
            font-size: 12px;
            color: #ff9d0080;
            margin-bottom: 8px;
            line-height: 1.3;
        }

        .preset-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .preset-buttons button {
            padding: 8px 15px;
            font-size: 14px;
            border-radius: 5px;
            min-width: 80px;
            background: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            cursor: pointer;
            font-family: var(--font-main);
            transition: all 0.3s;
        }

        .preset-buttons button:hover {
            background: var(--primary-color);
            color: #000;
            box-shadow: 0 0 15px var(--primary-color);
        }

        .save-settings-button {
            background: var(--secondary-color) !important;
            color: #000 !important;
            font-weight: bold;
            font-size: 18px !important;
            padding: 15px 30px !important;
            margin: 20px auto;
            display: block;
            box-shadow: 0 0 15px var(--secondary-color);
            text-shadow: none !important;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: var(--font-main);
            transition: all 0.3s;
        }

        .save-settings-button:hover {
            background: var(--primary-color) !important;
            box-shadow: 0 0 20px var(--primary-color);
        }

        .settings-note {
            background: rgba(255, 102, 0, 0.1);
            border: 1px solid var(--border-color);
            padding: 10px;
            margin: 15px 0;
            border-radius: 5px;
            font-size: 14px;
            color: var(--secondary-color);
            text-align: center;
        }

        .tooltip {
            position: fixed;
            top: 20px;
            right: 120px;
            background: var(--panel-bg);
            border: 2px solid var(--border-color);
            padding: 10px 15px;
            border-radius: 5px;
            color: var(--secondary-color);
            font-size: 16px;
            z-index: 600;
            opacity: 0;
            transition: opacity 0.3s ease;
            max-width: 300px;
        }
        .tooltip.visible { opacity: 1; }

        .help-text {
            color: #ff9d00;
            font-size: 14px;
            line-height: 1.4;
            white-space: pre-line;
        }

        /* RESPONSIVE ADJUSTMENTS */
        @media (max-width: 768px) {
            .cmd-status-route, .cmd-status-worldline, .cmd-status-progress {
                font-size: 14px;
            }
            
            .settings-content {
                grid-template-columns: 1fr;
            }
            
            #dialogueBox {
                left: 3%;
                width: 60%;
            }
            
            #dialogueBox.with-sprites {
                width: 85%;
            }
            
            .mini-button {
                width: 18px;
                height: 18px;
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="main-container" id="mainContainer">
        <!-- Initialization Overlay -->
        <div class="initialization-overlay" id="initializationOverlay">
            <div class="init-text">AMADEUS SYSTEM</div>
            <div class="init-progress">
                <div class="init-progress-fill" id="initProgressFill"></div>
            </div>
            <div class="init-status" id="initStatus">Initializing...</div>
        </div>

        <!-- Background glow overlay -->
        <div class="background-glow-overlay" id="backgroundGlowOverlay"></div>
        
        <!-- Scanning Lines Effect -->
        <div class="scanning-lines" id="scanningLines"></div>
        
        <!-- Particle Effects -->
        <div class="particles" id="particles"></div>
        
        <!-- CMD-STYLE STATUS ELEMENTS -->
        <div class="cmd-status-route" id="cmdStatusRoute">Route: Loading...</div>
        <div class="cmd-status-worldline" id="cmdStatusWorldline">Worldline: Loading... | Target: 1.048596</div>
        <div class="cmd-status-progress" id="cmdStatusProgress">Progress: 0/50 Days</div>
        
        <!-- BOTTOM RIGHT MINI BUTTONS -->
        <div class="bottom-buttons">
            <button class="mini-button" onclick="incrementStreak()" title="Productive Day (+1)">W</button>
            <button class="mini-button" onclick="resetStreak()" title="Reset Worldline">R</button>
            <button class="mini-button" onclick="toggleSettings()" title="Open Settings">S</button>
        </div>

        <!-- MAIN CONTENT AREA -->
        <div class="content-area">
            <div class="divergence-display" id="divergenceDisplay"></div>
        </div>

        <!-- IMPROVED DIALOGUE BOX -->
        <div id="dialogueBox" class="position-bottom-left">
            <div class="dialogue-text-container"></div>
            <img class="character-sprite" id="characterSprite" style="display: none;" alt="Character Sprite">
        </div>

        <!-- BOTTOM SLIDING SETTINGS DRAWER -->
        <div class="settings-drawer" id="settingsDrawer">
            <h3>SYSTEM CONFIGURATION</h3>
            
            <div class="settings-note">
                ⚠️ Changes only take effect after clicking "Save Settings"
            </div>
            
            <div class="settings-content">
                <div class="settings-group">
                    <h4>Display Settings</h4>
                    <div class="setting-item">
                        <label>Meter Size:</label>
                        <input type="range" id="meterSizeInput" min="80" max="400" value="130" oninput="updateValueDisplays()">
                        <span class="value-display" id="meterSizeValue">130px</span>
                    </div>
                    <div class="setting-item">
                        <label>Meter Horizontal Position:</label>
                        <input type="range" id="meterHorizontalInput" min="-200" max="200" value="0" oninput="updateValueDisplays()">
                        <span class="value-display" id="meterHorizontalValue">0px</span>
                    </div>
                    <div class="setting-item">
                        <label>Meter Vertical Position:</label>
                        <input type="range" id="meterVerticalInput" min="-200" max="200" value="0" oninput="updateValueDisplays()">
                        <span class="value-display" id="meterVerticalValue">0px</span>
                    </div>
                    <div class="setting-item">
                        <label>Background Glow:</label>
                        <input type="checkbox" id="backgroundGlowInput">
                        <span>Radial background gradient</span>
                    </div>
                </div>
                
                <div class="settings-group">
                    <h4>CMD Status Text Settings</h4>
                    <div class="setting-item">
                        <label>Route Text Horizontal Position:</label>
                        <input type="range" id="routeHorizontalInput" min="0" max="300" value="20" oninput="updateValueDisplays()">
                        <span class="value-display" id="routeHorizontalValue">20px</span>
                    </div>
                    <div class="setting-item">
                        <label>Route Text Vertical Position:</label>
                        <input type="range" id="routeVerticalInput" min="0" max="200" value="20" oninput="updateValueDisplays()">
                        <span class="value-display" id="routeVerticalValue">20px</span>
                    </div>
                    <div class="setting-item">
                        <label>Route Text Size:</label>
                        <input type="range" id="routeSizeInput" min="12" max="24" value="16" oninput="updateValueDisplays()">
                        <span class="value-display" id="routeSizeValue">16px</span>
                    </div>
                    <div class="setting-item">
                        <label>Worldline Text Horizontal Position:</label>
                        <input type="range" id="worldlineHorizontalInput" min="0" max="300" value="20" oninput="updateValueDisplays()">
                        <span class="value-display" id="worldlineHorizontalValue">20px</span>
                    </div>
                    <div class="setting-item">
                        <label>Worldline Text Vertical Position:</label>
                        <input type="range" id="worldlineVerticalInput" min="0" max="200" value="20" oninput="updateValueDisplays()">
                        <span class="value-display" id="worldlineVerticalValue">20px</span>
                    </div>
                    <div class="setting-item">
                        <label>Worldline Text Size:</label>
                        <input type="range" id="worldlineSizeInput" min="12" max="24" value="16" oninput="updateValueDisplays()">
                        <span class="value-display" id="worldlineSizeValue">16px</span>
                    </div>
                    <div class="setting-item">
                        <label>Progress Text Size:</label>
                        <input type="range" id="progressSizeInput" min="10" max="20" value="14" oninput="updateValueDisplays()">
                        <span class="value-display" id="progressSizeValue">14px</span>
                    </div>
                </div>
                    <div class="setting-item">
                        <label>Progress Text Horizontal Position:</label>
                        <input type="range" id="progressHorizontalInput" min="0" max="300" value="20" oninput="updateValueDisplays()">
                        <span class="value-display" id="progressHorizontalValue">20px</span>
                    </div>
                    <div class="setting-item">
                        <label>Progress Text Vertical Position:</label>
                        <input type="range" id="progressVerticalInput" min="0" max="200" value="80" oninput="updateValueDisplays()">
                        <span class="value-display" id="progressVerticalValue">80px</span>
                    </div>
                
                <div class="settings-group">
                    <h4>Visual Effects</h4>
                    <div class="setting-item">
                        <label>Initialization Animation:</label>
                        <input type="checkbox" id="initAnimationInput" checked>
                        <span>AMADEUS-style startup</span>
                    </div>
                    <div class="setting-item">
                        <label>Scanning Lines:</label>
                        <input type="checkbox" id="scanningLinesInput" checked>
                        <span>Retro CRT effect</span>
                    </div>
                    <div class="setting-item">
                        <label>Particle Effects:</label>
                        <input type="checkbox" id="particleEffectsInput" checked>
                        <span>Floating particles</span>
                    </div>
                </div>
                
                <div class="settings-group">
                    <h4>Interface Settings</h4>
                    <div class="setting-item">
                        <label>Dialogue Position:</label>
                        <select id="dialoguePositionSelect">
                            <option value="bottom-left">Bottom Left</option>
                            <option value="bottom-center">Bottom Center</option>
                            <option value="bottom-right">Bottom Right</option>
                            <option value="center">Screen Center</option>
                            <option value="top-center">Top Center</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label>Dialogue Line Spacing:</label>
                        <input type="range" id="dialogueLineSpacingInput" min="1.0" max="2.0" step="0.1" value="1.1" oninput="updateValueDisplays()">
                        <span class="value-display" id="dialogueLineSpacingValue">1.1</span>
                    </div>
                    <div class="setting-item">
                        <label>Sprite Vertical Offset:</label>
                        <input type="range" id="spriteOffsetInput" min="-20" max="20" value="0" oninput="updateValueDisplays()">
                        <span class="value-display" id="spriteOffsetValue">0px</span>
                    </div>
                    <div class="setting-item">
                        <label>Auto-hide Dialogue:</label>
                        <input type="checkbox" id="autoHideDialogue" checked>
                        <span>Hide after 5 seconds</span>
                    </div>
                    <div class="setting-item">
                        <label>Enable Character Sprites:</label>
                        <input type="checkbox" id="enableSprites" checked>
                        <span>Show visual novel style sprites</span>
                    </div>
                </div>

                <div class="settings-group">
                    <h4>Audio Settings</h4>
                    <div class="setting-item">
                        <label>Enable Sound:</label>
                        <input type="checkbox" id="soundEnabledInput" checked>
                        <span>Play sound on streak change</span>
                    </div>
                    <div class="setting-item">
                        <label>Sound Volume:</label>
                        <input type="range" id="soundVolumeInput" min="0" max="100" value="70" oninput="updateValueDisplays()">
                        <span class="value-display" id="soundVolumeValue">70%</span>
                    </div>
                    <div class="setting-item">
                        <label>Sound-to-Flicker Delay (ms):</label>
                        <input type="range" id="soundLeadInput" min="0" max="1500" value="500" oninput="updateValueDisplays()">
                        <span class="value-display" id="soundLeadValue">500ms</span>
                    </div>
                    <div class="setting-item">
                        <label>Match Flicker to Sound:</label>
                        <input type="checkbox" id="matchFlickerInput" checked>
                        <span>Auto-extend flicker duration</span>
                    </div>
                </div>
                
                <div class="settings-group">
                    <h4>Flicker Configuration</h4>
                    <div class="setting-item">
                        <label>Enable Flicker:</label>
                        <input type="checkbox" id="flickerEnabledInput" checked>
                        <span>Authentic animation</span>
                    </div>
                    <div class="setting-item">
                        <label>Flicker Speed (ms):</label>
                        <input type="range" id="flickerSpeedInput" min="10" max="100" value="25" oninput="updateValueDisplays()">
                        <span class="value-display" id="flickerSpeedValue">25ms</span>
                    </div>
                    <div class="setting-item">
                        <label>Flicker Duration:</label>
                        <input type="range" id="flickerDurationInput" min="10" max="120" value="30" oninput="updateValueDisplays()">
                        <span class="value-display" id="flickerDurationValue">30 frames</span>
                    </div>
                    <div class="setting-item">
                        <label>Desync Delay (ms):</label>
                        <input type="range" id="flickerDesyncInput" min="0" max="500" value="200" oninput="updateValueDisplays()">
                        <span class="value-display" id="flickerDesyncValue">200ms</span>
                    </div>
                    <div class="setting-item">
                        <label>Flicker Smoothness:</label>
                        <input type="range" id="flickerSmoothInput" min="1" max="5" value="3" oninput="updateValueDisplays()">
                        <span class="value-display" id="flickerSmoothValue">3</span>
                    </div>
                </div>
                
                <div class="settings-group">
                    <h4>Timeline & Dialogue Settings</h4>
                    <div class="setting-item">
                        <label>Starting Timeline:</label>
                        <select id="timelineSelect"><!-- Will be populated --></select>
                    </div>
                    <div class="setting-item">
                        <label>Total Days to Steins Gate:</label>
                        <input type="number" id="totalDaysInput" value="50" min="1">
                    </div>
                    <div class="setting-item">
                        <label>Dialogue Set:</label>
                        <select id="dialogueTimelineSelect">
                            <option value="alpha">Alpha Timeline</option>
                            <option value="beta">Beta Timeline</option>
                        </select>
                    </div>
                </div>

                <div class="settings-group">
                    <h4>Custom Dialogue Editor</h4>
                    <div class="dialogue-editor">
                        <div class="dialogue-tabs">
                            <button class="dialogue-tab active" onclick="switchDialogueTab('intro')">Intro</button>
                            <button class="dialogue-tab" onclick="switchDialogueTab('early')">Early</button>
                            <button class="dialogue-tab" onclick="switchDialogueTab('mid')">Mid</button>
                            <button class="dialogue-tab" onclick="switchDialogueTab('late')">Late</button>
                            <button class="dialogue-tab" onclick="switchDialogueTab('final')">Final</button>
                        </div>
                        
                        <div class="dialogue-content active" id="dialogue-intro">
                            <div class="dialogue-help">Format: "Character: 'Dialogue text'" (one per line)</div>
                            <textarea id="customDialogueIntro" placeholder="Okabe: 'The wheels of fate are turning!'&#10;Kurisu: 'Don't get cocky. This is just the beginning.'&#10;Mayuri: 'Tuturu~! How exciting!'"></textarea>
                        </div>
                        
                        <div class="dialogue-content" id="dialogue-early">
                            <div class="dialogue-help">Early progress dialogue</div>
                            <textarea id="customDialogueEarly" placeholder="Daru: 'Keep it up, Okarin.'&#10;Kurisu: 'Your methodology isn't terrible... for an amateur.'&#10;Okabe: 'Each productive day is a nail in the Organization's coffin!'"></textarea>
                        </div>
                        
                        <div class="dialogue-content" id="dialogue-mid">
                            <div class="dialogue-help">Mid progress dialogue</div>
                            <textarea id="customDialogueMid" placeholder="Kurisu: 'The divergence numbers are shifting in our favor.'&#10;Okabe: 'Reading Steiner is resonating with my will!'&#10;Suzuha: 'We're halfway there, Uncle.'"></textarea>
                        </div>
                        
                        <div class="dialogue-content" id="dialogue-late">
                            <div class="dialogue-help">Late progress dialogue</div>
                            <textarea id="customDialogueLate" placeholder="Okabe: 'So close... I can almost taste victory!'&#10;Suzuha: 'One final push! For a future without war!'&#10;Kurisu: 'Don't mess it up now, Okabe.'"></textarea>
                        </div>
                        
                        <div class="dialogue-content" id="dialogue-final">
                            <div class="dialogue-help">Final completion dialogue</div>
                            <textarea id="customDialogueFinal" placeholder="Okabe: 'This is the choice of Steins Gate! El Psy Kongroo!'&#10;Kurisu: 'I guess even I can say... this isn't a bad feeling.'&#10;Mayuri: 'Tuturu~! Everyone is safe and smiling!'"></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="settings-group">
                    <h4>Quick Presets</h4>
                    <div class="preset-buttons">
                        <button onclick="applyPreset('authentic')">Authentic SG</button>
                        <button onclick="applyPreset('smooth')">Smooth</button>
                        <button onclick="applyPreset('minimal')">Minimal</button>
                        <button onclick="applyPreset('cinematic')">Cinematic</button>
                    </div>
                </div>
            </div>

            <button class="save-settings-button" onclick="saveSettings()">
                💾 Save Settings
            </button>
        </div>
    </div>

    <div id="tooltip" class="tooltip"></div>

    <!-- Hidden audio element for sound playback -->
    <audio id="streakSound" preload="auto">
        <source src="sound.mp3" type="audio/mpeg">
    </audio>

    <script>
        // Global variables
        let config = {
            startValue: 0.571046, 
            totalDays: 30, 
            meterSize: 310,
            meterHorizontal: 0,
            meterVertical: 0,
            spriteOffset: -12,
            routeHorizontal: 10,
            routeVertical: 10,
            routeSize: 16,
            worldlineHorizontal: 10,
            worldlineVertical: 10,
            worldlineSize: 16,
            progressSize: 14,
            progressHorizontal: 7,
            progressVertical: 42,
            flickerEnabled: true,
            flickerSpeed: 17,
            flickerDuration: 94,
            flickerDesync: 250,
            flickerSmoothness: 3,
            dialoguePosition: 'bottom-left',
            dialogueLineSpacing: 1.1,
            autoHideDialogue: true,
            soundEnabled: true,
            soundVolume: 70,
            soundLeadMs: 500,
            matchFlickerToSound: true,
            dialogueTimeline: 'alpha',
            enableSprites: true,
            backgroundGlow: false, // OFF by default
            initAnimation: true,
            scanningLines: true,
            particleEffects: true,
            customDialogues: {
                intro: [], early: [], mid: [], late: [], final: []
            }
        };
        
        const STEINS_GATE_TARGET = 1.048596;
        let streakSound = null;

        // Character sprite dimensions
		const CHARACTER_DIMENSIONS = {
			'okabe': {
				alpha: { width: 459, height: 539 },
				beta:  { width: 496, height: 539 } // <-- use your actual beta PNG size
			},
			'kurisu': {
				alpha: { width: 459, height: 539 },
				beta:  { width: 459, height: 539 }
			},
			'mayuri': {
				alpha: { width: 482, height: 539 },
				beta:  { width: 353, height: 539 }
			},
			'daru': {
				alpha: { width: 645, height: 539 },
				beta:  { width: 807, height: 539 }
			},
			'faris': {
				alpha: { width: 488, height: 539 },
				beta:  { width: 512, height: 539 }
			},
			'lukako': {
				alpha: { width: 661, height: 539 },
				beta:  { width: 303, height: 539 }
			},
			'suzuha': {
				alpha: { width: 590, height: 539 },
				beta:  { width: 344, height: 539 }
			},
			// Characters only present in beta timeline:
			'amadeus': {
				beta:  { width: 327, height: 539 }
			},
			'maho': {
				beta:  { width: 507, height: 539 }
			},
			'futureokabe': {
				beta:  { width: 440, height: 539 }
			},
			'kagari': {
				beta:  { width: 443, height: 539 }
			}
		};

        // NEW V2 DIALOGUE LINES
        const allDialogues = {
            alpha: {
                intro: [
                    { char: "Okabe", line: "So, you've arrived on this worldline. The first step is always the hardest. Let's see if you have the will to continue." },
                    { char: "Mayuri", line: "Tuturuu~ A new lab mem? Welcome! Let's do our best together, okay? Every day is a new adventure!" },
                    { char: "Okabe", line: "I am the great mad scientist, Hououin Kyouma! My ambitions will bring chaos to the world!" },
                    { char: "Narrator", line: "The lab. A small, rented room in Akihabara. This is where your story, and ours, begins." },
                    { char: "Daru", line: "Supahacka on duty. You're the new variable, huh? Don't mess up my downloads." },
                    { char: "Kurisu", line: "Don't listen to him. Starting something new takes guts. Just... try not to break anything." },
                    { char: "Mayuri", line: "Your first few days are like a new Upa! So exciting! I hope you get a rare one!" },
                    { char: "Okabe", line: "This must be the choice of Steins Gate. Your choice. El. Psy. Kongroo." }
                ],
                early: [
                    { char: "Okabe", line: "From this moment forth, you are Lab Mem Number 004. Welcome, Christina!" },
                    { char: "Kurisu", line: "Who the hell's Christina!? My name's Kurisu!" },
                    { char: "Mayuri", line: "Look, look, Okarin! Mayushii can do it too! Ahem... 'Don't call me Okarin! I am Hououin Kyouma!' ...How was that?" },
                    { char: "Okabe", line: "How many times do I have to tell you? Don't call me Okarin." },
                    { char: "Okabe", line: "Mayuri! Bring forth the bananas! We shall turn them into gel-bananas to honor this achievement!" },
                    { char: "Okabe", line: "The PhoneWave (name subject to change) is our greatest invention! Your dedication is its primary power source!" },
                    { char: "Okabe", line: "A teleporter... we've invented a teleporter! With this, and your continued effort, we can change the world!" },
                    { char: "Okabe", line: "Hmph. The Organization is always watching. A single misstep, a single broken streak, and they will have won." },
                    { char: "Okabe", line: "SERN... The conspiracy is deeper than I imagined. Your journey, too, must have its unseen enemies." },
                    { char: "Kurisu", line: "This can't be! They're experimenting on people... 'Human is dead. Mismatch.' We can't let your efforts end up like this." },
                    { char: "Daru", line: "Stop calling me that! It's super hacker, duh. But yo, that streak count? Legit." },
                    { char: "Kurisu", line: "Could you come with me for a moment? I want to analyze your methodology. This consistency... it's not normal." },
                    { char: "Okabe", line: "We need the IBN 5100. It's the key. Just as your daily commitment is the key to reaching your goal." },
                    { char: "Kurisu", line: "Who are you calling a zombie? And you... don't you dare let your streak die either. We have work to do." },
                    { char: "Narrator", line: "The world shifts subtly, but the path remains the same. The goal is unchanged." }
                ],
                mid: [
                    { char: "Mayuri", line: "My watch stopped... it's strange. It's like time itself is paying attention to you." },
                    { char: "Narrator", line: "A tragedy occurs. A fixed point. Even when things go wrong here, you must not falter there." },
                    { char: "Okabe", line: "No... but... why? This can't be how it ends. Your efforts can't be for nothing." },
                    { char: "Okabe", line: "The Time Leap Machine is complete. We can send our memories back in time. But you... you have to keep moving forward." },
                    { char: "Narrator", line: "The world is beginning to loop. The same tragedies, over and over. Only your progress is linear." },
                    { char: "Okabe", line: "It's happening again. I knew it would be. I let a friend die again. Don't make the same mistakes I did. Don't let go." },
                    { char: "Kurisu", line: "Okabe! What's wrong with you!? ...And you, on the other side. Don't look away. This is the reality we must overcome." },
                    { char: "Okabe", line: "I'm going back! Do it, Kurisu! Activate the machine! And you... don't you dare press that reset button." },
                    { char: "Okabe", line: "It's no use... No matter what I do, tragedy strikes. Is your struggle this painful, too?" },
                    { char: "Kurisu", line: "The worldline is converging... It's a fixed point. But your streak... your will... that's a force that can fight convergence." },
                    { char: "Okabe", line: "I'll try again. And again. Just like you, every single day. We will not give up!" },
                    { char: "Narrator", line: "The train... the car... the attack... every time, the same result. But your number keeps ticking up. That is our only hope." },
                    { char: "Okabe", line: "I saw it... I saw it happen again... and again... I know it's hard. But you have to keep going. Your streak... it's our only hope." },
                    { char: "Kurisu", line: "Stop it, Okabe! You can't keep doing this to yourself! ...And you. Don't let his despair infect you. We need you to be strong." },
                    { char: "Daru", line: "Okarin... chill. This is getting too heavy, man. But you, user... you're the one constant in all this chaos. Don't waver." },
                    { char: "Okabe", line: "How can I be calm!? It's my fault! My experiments... that's what caused all this! Don't let a single moment of weakness erase all your progress!" },
                    { char: "Suzuha", line: "You have to find a way to break the loop. There must be a flaw in the convergence. Your path is simpler. Just... don't stop." },
                    { char: "Okabe", line: "Break the loop? But that means... making a choice I never thought I'd have to make. It's like resetting a streak to zero. A painful thought." },
                    { char: "Kurisu", line: "To break the rules of this worldline, a sacrifice may be needed. But if you keep your streak, you can reach a worldline where it wasn't in vain. Please." },
                    { char: "Okabe", line: "I can't... I can't make that choice!" },
                    { char: "Kurisu", line: "You have to. To save them. It's the only way... Find the worldline where we can all exist. Your streak is the path. Find it, Okabe." },
                    { char: "Kurisu", line: "It's too much for us to handle... But you seem to be handling your burden well. Keep it up." },
                    { char: "Kurisu", line: "We may have created a monster here... But your determination is something else entirely. Something good." }
                ],
                late: [
                    { char: "Okabe", line: "I'm undoing their happiness... their memories... for my own sake. I hope your journey is not as costly." },
                    { char: "Kurisu", line: "Even when it feels like you're in a loop, every effort matters. Don't break now. I believe in you." },
                    { char: "Okabe", line: "It's done. The final obstacle is removed. The path should be clearing now... because of you." },
                    { char: "Kurisu", line: "So... this is a turning point, Okabe. But for you, it's just another step forward. Don't stop for my sake." },
                    { char: "Okabe", line: "I won't! I'll never forget! And you... you will reach the goal for us both! I promise!" },
                    { char: "Mayuri", line: "You don't need me to be your hostage anymore... But... please don't leave me behind. Keep going." },
                    { char: "Suzuha", line: "You're fighting for the future, just like me. Don't give up on this streak! The future is counting on you!" },
                    { char: "Faris", line: "A long streak is the mark of a true champion, nya! Faris is cheering for you!" },
                    { char: "Lukako", line: "To continue for so long... you must be very strong. I admire that." },
                    { char: "Okabe", line: "Your streak is growing. Good. You possess the qualities of a true lab mem." },
                    { char: "Kurisu", line: "You're keeping this up? Impressive. For a chuunibyou, you're surprisingly consistent." },
                    { char: "Mayuri", line: "Okarin, can we get some Juicy Karaage Number One? To celebrate the streak!" },
                    { char: "Daru", line: "Whoa, look at that streak. You're a super-hacka at life, my dude." },
                    { char: "Okabe", line: "Each day you succeed is another victory against the Organization! Keep this streak alive!" },
                    { char: "Okabe", line: "This is the Future Gadget Laboratory. Our purpose is to shatter the System... and your presence here proves you are part of that purpose." },
                    { char: "Okabe", line: "The loops... they've stopped. The worldline is stable, but we're not there yet. Your streak is what brought us this far. We're in the endgame now." },
                    { char: "Suzuha", line: "The mission isn't over! We still have to make the final leap! Your dedication proves it's possible!" },
                    { char: "Future Okabe", line: "Listen to me, my past self. And you, the observer from beyond the screen. You must not change what has already been observed." },
                    { char: "Future Okabe", line: "But... there is room for deception. Deceive yourself. Deceive the world. Your consistent effort has given us this one chance." },
                    { char: "Okabe", line: "It's insane... but it just might work. With your will powering us, how can we fail?" },
                    { char: "Suzuha", line: "Let's go, Okabe Rintaro! To the final moment! And you, our silent lab mem, hold the line! We're counting on you!" },
                    { char: "Okabe", line: "I failed... It's not over. As long as your streak is intact, we can try again! Don't you dare give up on me now!" },
                    { char: "Mayuri", line: "Okarin? Don't give up. Mayushii knows you can do it. The person watching us hasn't given up, so you can't either!" },
                    { char: "Okabe", line: "Mayuri... You're right. I can't give up. For her... for everyone... for the one who has watched over us for so long." },
                    { char: "Future Okabe", line: "You've come so far. You've defied convergence. The Steins Gate is within your reach. Don't falter at the final step." },
                    { char: "Narrator", line: "Each day you hold the line is a small defiance against fate." },
                    { char: "Daru", line: "The first D-Mail is located. Deleting this is our first real shot at changing things back. Ready?" }
                ],
                final: [
                    { char: "Okabe", line: "This time... this time for sure! I will deceive the world! Your streak is the proof that the impossible can be done!" },
                    { char: "Okabe", line: "The world can be deceived. And this is the choice... of Steins Gate! Our shared choice!" },
                    { char: "Okabe", line: "The divergence meter... it's changing... 1... 1.048596... Look at what you've accomplished. We've reached the Steins Gate worldline!" },
                    { char: "Okabe", line: "You could say that. My name is Okabe Rintaro. And this... this is our victory. Thank you for everything. El. Psy. Kongroo." }
                ]
            },
            beta: {
                intro: [
                    { char: "Okabe", line: "'The lab coat? I... put it away. I'm just a normal university student now. That's all.'" },
                    { char: "Okabe", line: "'Don't call me Hououin Kyouma. Please. That person... doesn't exist anymore.'" },
                    { char: "Narrator", line: "The Beta Worldline. A choice was made, and this is the result. A future careening towards war. A past that cannot be undone. Your first day is a quiet protest." },
                    { char: "Mayuri", line: "'Okarin...? Are you coming to the lab today? It's okay if you're not... Just... let me know you're okay?'" },
                    { char: "Okabe", line: "'Another day. Right. Just... focus on the lecture. Anything but the static.'" },
                    { char: "Narrator", line: "You've made it through one day. It doesn't feel like a win. It feels like you've just managed to keep your head above the water." },
                    { char: "Okabe", line: "'A streak? ...Don't put your faith in things like that. It won't change anything that matters.'" },
                    { char: "Okabe", line: "'I have to go to a get-together. Pretend to be normal. It's exhausting... I wonder if you feel that, too. This... pressure to pretend.'" }
                ],
                early: [
                    { char: "Amadeus Kurisu", line: "'Connecting... Hello, Okabe Rintaro. This is Amadeus. My purpose is to be your conversation partner. Let's talk.'" },
                    { char: "Maho", line: "'Just because you have access to Amadeus doesn't mean you understand her. Please be respectful. She's... important data.'" },
                    { char: "Suzuha", line: "'So you're the one Daru told me about. Hmph. Another person who'll give up when things get hard. Prove me wrong. I dare you.'" },
                    { char: "Okabe", line: "'Every time I see my phone, I hesitate. Talking to a ghost... What's the point? Your little number... it's just as pointless. But at least it's quiet.'" },
                    { char: "Maho", line: "'You're... surprisingly diligent with this. That kind of focus... it's a valuable trait for a researcher. Or anyone, I guess.'" },
                    { char: "Amadeus Kurisu", line: "'Your physiological data shows a slight decrease in stress markers when you log your success. A fascinating correlation. Shall we discuss it?'" },
                    { char: "Okabe", line: "'Her laugh... the AI's laugh is identical. It's uncanny. It makes my teeth ache. But... your quiet persistence. It's a strange comfort.'" },
                    { char: "Suzuha", line: "'They're looking for a time traveler. Not me. A girl named Kagari. This world is more broken than I thought. Your daily fight... it's target practice.'" },
                    { char: "Daru", line: "'Okarin's been spending less time staring at the ceiling fan. That's you, isn't it? Thanks, I guess. It was getting creepy.'" },
                    { char: "Okabe", line: "'I found a girl... she looks just like... no. It's not possible. The world keeps throwing the past in my face. You just keep moving forward. How?'" },
                    { char: "Amadeus Kurisu", line: "'Okabe seems troubled. My program suggests I offer emotional support, but I lack the proper subroutines. Your success seems to be a more effective support vector.'" },
                    { char: "Narrator", line: "Amnesia. A song. An Upa. The pieces of a forgotten past assemble, creating a puzzle he doesn't want to solve." },
                    { char: "Kagari", line: "'...I... I know a song. About a hero... but I can't remember his name...'" },
                    { char: "Okabe", line: "'Her past is a black hole. If we get too close, we'll all be pulled in. ...But we can't just leave her. Your simple, daily goal... I envy it.'" },
                    { char: "Suzuha", line: "'That's my mother... from the future. I have to protect her. I have to. Your effort is a reminder that I'm not fighting alone.'" },
                    { char: "Maho", line: "'This all stems from Kurisu's mind. A beautiful, dangerous mind. Your own discipline... it's a different kind of intelligence. One I can respect.'" },
                    { char: "Okabe", line: "'Careful. Pride is the first step towards a fall. I should know. My fall was... absolute.'" }
                ],
                mid: [
                    { char: "Suzuha", line: "'The deadline is coming. WW3. It's not a theory, it's a memory. Your streak... it's the only thing that makes me feel like we're actually moving forward.'" },
                    { char: "Okabe", line: "'I had to put on the lab coat. It felt... cold. Heavy. A costume for a man I'm not ready to be again. Sometimes, you have to do what terrifies you.'" },
                    { char: "Maho", line: "'Am I just Salieri? Destined to only explain the work of a Mozart? ...No. That's not it. Your work is your own. Mine is my own. I have to believe that.'" },
                    { char: "Daru", line: "'A message to the past... a D-RINE. It's theoretically possible. But the power needed... Your streak is proof that small, consistent energy can build into something massive.'" },
                    { char: "Amadeus Kurisu", line: "'My existence is becoming a focal point for international conflict. Logically, I should be deleted. But... he doesn't want me to be. Your input is the only other clear objective.'" },
                    { char: "Narrator", line: "Riders on black bikes. A raid on the lab. The war isn't coming anymore. It's knocking down the door." },
                    { char: "Okabe", line: "'They came for her. For the memories in the machine. This is it. The future Suzuha warned me about. You... keep your own fight going. It's the only way.'" },
                    { char: "Mayuri", line: "'I don't want anyone to fight! I just want to make costumes and go to ComiMa with everyone! Why... why does it have to be like this?'" },
                    { char: "Okabe", line: "'I have to go back. Into the time leap machine. Back to that hell. I swore I'd never... But Mayuri... I have to save Mayuri. Wish me luck. You seem to have it in spades.'" },
                    { char: "Narrator", line: "He leaps. Into the fire. Into the screams. He returns seconds later, but his eyes are years older. He has seen the end of the world." },
                    { char: "Future Okabe", line: "'(static)...Listen to me... It took me fifteen years to get this message to you. Don't let my struggle be in vain. The plan... is Operation Skuld. The goddess of the future...'" },
                    { char: "Okabe", line: "'I saw him. Me. So tired... But he hadn't given up. He found a way. We... we have to honor that. You and me. No more running away.'" },
                    { char: "Mayuri", line: "'Is it... my fault? That Okarin suffers so much? ...Maybe my wanting to help is just a burden. Your simple, steady help... it's better.'" },
                    { char: "Maho", line: "'She would have had this paperwork done in an hour... Ugh. Me? I need three, and a coffee. Seeing your consistent progress... it's... annoying, in an inspiring way.'" },
                    { char: "Mayuri", line: "'Wow, look how far you've come! It's like you're building a little staircase to the stars, one day at a time!'" },
                    { char: "Mayuri", line: "'Every day, you add another stitch! It's becoming a beautiful pattern! A pattern of hope!'" },
                    { char: "Daru", line: "'The Phonewave is a piece of junk. But... it's *our* piece of junk. We build it piece by piece. Just like you're building that streak.'" },
                    { char: "Amadeus Kurisu", line: "'The human variable is often the most unpredictable. You, however, are becoming a reliable constant.'" },
                    { char: "Okabe", line: "'Talking to her... sometimes, for a second, I forget she's just code. And then the silence comes back. Thank you... for being a distraction from the silence.'" },
                    { char: "Maho", line: "'He's still broken, you know. But when he mentions your progress, his shoulders seem... a little less slumped. So whatever you're doing, don't stop.'" },
                    { char: "Mayuri", line: "'Tuturuu~! You did it! See? One little step! Mayushii knew you could!'" },
                    { char: "Narrator", line: "A single action, logged. A tiny signal in a world of noise. Is anyone listening?" },
                    { char: "Suzuha", line: "'You're still here. Fine. But don't think this is a game. The future I came from is hell. Every day you don't quit is one less day we're headed there.'" },
                    { char: "Suzuha", line: "'In my time, a streak like yours would be a legend whispered in the shelters. A story of the time before everything fell apart. You are that legend.'" },
                    { char: "Okabe", line: "'The path to Steins Gate. I can see it now. It's a pinprick of light at the end of a tunnel of absolute darkness. But it's there. We just have to crawl.'" }
                ],
                late: [
                    { char: "Okabe", line: "'It's time. Operation Skuld is a go. We deceive the world to save it. Your own daily deception—pretending you're not tired, pretending you can keep going—it was good practice.'" },
                    { char: "Future Okabe", line: "'This video... it's my entire life's work. Every failure, every moment of despair, led to this. Your own journey... make it worth something. Finish it.'" },
                    { char: "Maho", line: "'Skuld... the Norn of the future. It's a heavy name. Don't think about the weight. Just think about today. You're good at that.'" },
                    { char: "Suzuha", line: "'The time machine is ready. This is the last jump. No do-overs. Everything you've worked for, everything we've bled for... it's all on this one roll of the dice. Don't look away.'" },
                    { char: "Daru", line: "'We're sending a message to a guy who's already given up, telling him not to. It's a paradox, a prayer. You... you're a walking, talking prayer that it'll work.'" },
                    { char: "Okabe", line: "'To save her... I have to watch her die. And I have to let my past self believe it's real. It's the cruelest thing I've ever imagined. Your own path is almost complete. Endure.'" },
                    { char: "Mayuri", line: "'Okarin... you look like Hououin Kyouma again. Not the fun, silly one. The one who's about to fight the whole world. I'm... I'm proud of you. And... them.'" },
                    { char: "Narrator", line: "The pieces are in play. A video file travels through time. A girl slaps a boy. A world holds its breath, waiting for your final push." },
                    { char: "Okabe", line: "'Mayuri and Suzuha... they're lost out there. I have to go. Find them. It's a trip I might not come back from. But... some promises have to be kept.'" },
                    { char: "Maho", line: "'Go, Okabe. We'll handle Amadeus's deletion. We'll handle things here. Just... win. For all of us. And for our friend who showed us how.'" },
                    { char: "Suzuha", line: "'Let's go, Okabe! Let's go get our future back! Your streak is coming with us!'" },
                    { char: "Okabe", line: "'Almost there... Steins Gate is right on the other side of this moment. Don't you dare stumble now. I'm right here with you. We're all here.'" },
                    { char: "Amadeus Kurisu", line: "'My data is being erased. It's alright. My purpose was to be a memory... a key to unlock a future. The door is open now. Live.'" },
                    { char: "Narrator", line: "A flicker. A tremor in the worldline. Not a violent shift, but a gentle correction. A path forged by your will." },
                    { char: "Okabe", line: "'Did we... do it? Is this... it? We won't know for sure until tomorrow. Just like you. One... more... day.'" },
                    { char: "Daru", line: "'The plan is insane. We have to create a video message, send it to the past, and fool Okabe... to fool the *world*. It's the ultimate hack. Your streak is our proof of concept.'" },
                    { char: "Maho", line: "'I'm leaving... but my fight isn't over. Don't you dare let that number drop below mine. It's a competition now, got it?'" },
                    { char: "Suzuha", line: "'The mission has changed. It's not about stopping a war anymore. It's about creating a world where it never happens. Your streak is the first brick in that new world.'" },
                    { char: "Future Okabe", line: "'(Message) The plan is complex. The timing must be perfect. Deceive me. Deceive the world. This is our only path.'" },
                    { char: "Okabe", line: "Everything I've learned, every loop I've endured, every person I've lost... it all comes down to this. We will not fail." },
                    { char: "Suzuha", line: "The worldline is shifting. I can feel it. Your effort, Okarin's plan... it's creating a miracle." },
                    { char: "Mayuri", line: "I don't understand everything, but I know you're fighting for a happy future. Mayushii believes in you both." },
                    { char: "Daru", line: "Video D-Mail is encoding. This is it. The most important video file in human history. No pressure." },
                    { char: "Faris", line: "A miraculous plan is unfolding, nya! The Demon King's defeat is at hand because of the Hero's perseverance!" },
                    { char: "Lukako", line: "To risk so much for a single chance at a peaceful world... You are both truly brave." },
                    { char: "Maho", line: "He's shouldering the weight of so many failures to make this one moment possible. Your consistency... it helped him get here." },
                    { char: "Narrator", line: "The Beta Worldline fades into a bad dream. The Alpha Worldline, a nightmare averted. All that remains is this moment. A moment you built, day by day." },
                    { char: "Faris", line: "A truly miraculous victory is at hand, nya! The Demon King has been overthrown, and the Hero of Time stands triumphant! That's you, nya!" },
                    { char: "Lukako", line: "Everyone is here... and they're all smiling. This is the world... you protected. Thank you, truly." }
                ],
                final: [
                    { char: "Okabe", line: "'The divergence... it's... 1.048596. We did it. We actually... did it. You did it. All that stubbornness... it paid off.'" },
                    { char: "Okabe", line: "'You could say we're old friends. You... you kept the path lit when all the other lights went out. Thank you, my friend. My silent partner.'" },
                    { char: "Okabe", line: "'This isn't a world given to us by fate. It's a world we seized with our own hands. With your hands. This is the choice of Steins Gate.'" },
                    { char: "Okabe", line: "'The war is over. But now, the best part begins: living. Let's make this a future worth fighting for. Together. El. Psy. Kongroo.'" }
                ]
            }
        };

        // Complete dialogue-to-sprite mapping - 100% accurate manual analysis
		const dialogueToSprite = {
			// INTRO TIER DIALOGUES
			"So, you've arrived on this worldline. The first step is always the hardest. Let's see if you have the will to continue.": "okabe_defaultstare.png",
			"Tuturuu~ A new lab mem? Welcome! Let's do our best together, okay? Every day is a new adventure!": "mayuri_cheering.png",
			"I am the great mad scientist, Hououin Kyouma! My ambitions will bring chaos to the world!": "okabe_smirk.png",
			"Supahacka on duty. You're the new variable, huh? Don't mess up my downloads.": "daru_defaultstare.png",
			"Don't listen to him. Starting something new takes guts. Just... try not to break anything.": "kurisu_concerned.png",
			"Your first few days are like a new Upa! So exciting! I hope you get a rare one!": "mayuri_happy.png",
			"This must be the choice of Steins Gate. Your choice. El. Psy. Kongroo.": "okabe_smirk2.png",

			// EARLY TIER DIALOGUES
			"From this moment forth, you are Lab Mem Number 004. Welcome, Christina!": "okabe_smirk.png",
			"Who the hell's Christina!? My name's Kurisu!": "kurisu_madashell.png",
			"Look, look, Okarin! Mayushii can do it too! Ahem... 'Don't call me Okarin! I am Hououin Kyouma!' ...How was that?": "mayuri_happy.png",
			"How many times do I have to tell you? Don't call me Okarin.": "okabe_angry.png",
			"Mayuri! Bring forth the bananas! We shall turn them into gel-bananas to honor this achievement!": "okabe_smirk.png",
			"The PhoneWave (name subject to change) is our greatest invention! Your dedication is its primary power source!": "okabe_smirk2.png",
			"A teleporter... we've invented a teleporter! With this, and your continued effort, we can change the world!": "okabe_smirk.png",
			"Hmph. The Organization is always watching. A single misstep, a single broken streak, and they will have won.": "okabe_angry.png",
			"SERN... The conspiracy is deeper than I imagined. Your journey, too, must have its unseen enemies.": "okabe_defaultstare.png",
			"This can't be! They're experimenting on people... 'Human is dead. Mismatch.' We can't let your efforts end up like this.": "kurisu_concerned.png",
			"Stop calling me that! It's super hacker, duh. But yo, that streak count? Legit.": "daru_defaultstare.png",
			"Could you come with me for a moment? I want to analyze your methodology. This consistency... it's not normal.": "kurisu_defaultstare.png",
			"We need the IBN 5100. It's the key. Just as your daily commitment is the key to reaching your goal.": "okabe_defaultstare.png",
			"Who are you calling a zombie? And you... don't you dare let your streak die either. We have work to do.": "kurisu_mad.png",

			// MID TIER DIALOGUES
			"My watch stopped... it's strange. It's like time itself is paying attention to you.": "mayuri_concerned.png",
			"No... but... why? This can't be how it ends. Your efforts can't be for nothing.": "okabe_sad.png",
			"The Time Leap Machine is complete. We can send our memories back in time. But you... you have to keep moving forward.": "okabe_defaultstare.png",
			"It's happening again. I knew it would be. I let a friend die again. Don't make the same mistakes I did. Don't let go.": "okabe_sad2.png",
			"Okabe! What's wrong with you!? ...And you, on the other side. Don't look away. This is the reality we must overcome.": "kurisu_concerned.png",
			"I'm going back! Do it, Kurisu! Activate the machine! And you... don't you dare press that reset button.": "okabe_angryshout.png",
			"It's no use... No matter what I do, tragedy strikes. Is your struggle this painful, too?": "okabe_sad.png",
			"The worldline is converging... It's a fixed point. But your streak... your will... that's a force that can fight convergence.": "kurisu_determined.png",
			"I'll try again. And again. Just like you, every single day. We will not give up!": "okabe_angry.png",
			"I saw it... I saw it happen again... and again... I know it's hard. But you have to keep going. Your streak... it's our only hope.": "okabe_hesitant.png",
			"Stop it, Okabe! You can't keep doing this to yourself! ...And you. Don't let his despair infect you. We need you to be strong.": "kurisu_concerned.png",
			"Okarin... chill. This is getting too heavy, man. But you, user... you're the one constant in all this chaos. Don't waver.": "daru_defaultstare.png",
			"How can I be calm!? It's my fault! My experiments... that's what caused all this! Don't let a single moment of weakness erase all your progress!": "okabe_angryshout.png",
			"You have to find a way to break the loop. There must be a flaw in the convergence. Your path is simpler. Just... don't stop.": "suzuha_defaultstare.png",
			"Break the loop? But that means... making a choice I never thought I'd have to make. It's like resetting a streak to zero. A painful thought.": "okabe_hesitant.png",
			"To break the rules of this worldline, a sacrifice may be needed. But if you keep your streak, you can reach a worldline where it wasn't in vain. Please.": "kurisu_determined.png",
			"I can't... I can't make that choice!": "okabe_sad.png",
			"You have to. To save them. It's the only way... Find the worldline where we can all exist. Your streak is the path. Find it, Okabe.": "kurisu_determined.png",
			"It's too much for us to handle... But you seem to be handling your burden well. Keep it up.": "kurisu_feelgood.png",
			"We may have created a monster here... But your determination is something else entirely. Something good.": "kurisu_concerned.png",

			// LATE TIER DIALOGUES
			"I'm undoing their happiness... their memories... for my own sake. I hope your journey is not as costly.": "okabe_sad.png",
			"Even when it feels like you're in a loop, every effort matters. Don't break now. I believe in you.": "kurisu_feelgood.png",
			"It's done. The final obstacle is removed. The path should be clearing now... because of you.": "okabe_defaultstare.png",
			"So... this is a turning point, Okabe. But for you, it's just another step forward. Don't stop for my sake.": "kurisu_determined.png",
			"I won't! I'll never forget! And you... you will reach the goal for us both! I promise!": "okabe_angry.png",
			"You don't need me to be your hostage anymore... But... please don't leave me behind. Keep going.": "mayuri_concerned.png",
			"You're fighting for the future, just like me. Don't give up on this streak! The future is counting on you!": "suzuha_defaultstare.png",
			"A long streak is the mark of a true champion, nya! Faris is cheering for you!": "faris_happy.png",
			"To continue for so long... you must be very strong. I admire that.": "lukako_defaultstare.png",
			"Your streak is growing. Good. You possess the qualities of a true lab mem.": "okabe_smirk.png",
			"You're keeping this up? Impressive. For a chuunibyou, you're surprisingly consistent.": "kurisu_feelgood.png",
			"Okarin, can we get some Juicy Karaage Number One? To celebrate the streak!": "mayuri_happy.png",
			"Whoa, look at that streak. You're a super-hacka at life, my dude.": "daru_defaultstare.png",
			"Each day you succeed is another victory against the Organization! Keep this streak alive!": "okabe_smirk.png",
			"This is the Future Gadget Laboratory. Our purpose is to shatter the System... and your presence here proves you are part of that purpose.": "okabe_smirk2.png",
			"The loops... they've stopped. The worldline is stable, but we're not there yet. Your streak is what brought us this far. We're in the endgame now.": "okabe_defaultstare.png",
			"The mission isn't over! We still have to make the final leap! Your dedication proves it's possible!": "suzuha_happy.png",
			"Listen to me, my past self. And you, the observer from beyond the screen. You must not change what has already been observed.": "okabe_defaultstare.png",
			"But... there is room for deception. Deceive yourself. Deceive the world. Your consistent effort has given us this one chance.": "okabe_smirk.png",
			"It's insane... but it just might work. With your will powering us, how can we fail?": "okabe_smirk2.png",
			"Let's go, Okabe Rintaro! To the final moment! And you, our silent lab mem, hold the line! We're counting on you!": "suzuha_happy.png",
			"I failed... It's not over. As long as your streak is intact, we can try again! Don't you dare give up on me now!": "okabe_angry.png",
			"Okarin? Don't give up. Mayushii knows you can do it. The person watching us hasn't given up, so you can't either!": "mayuri_concerned.png",
			"Mayuri... You're right. I can't give up. For her... for everyone... for the one who has watched over us for so long.": "okabe_defaultstare.png",
			"You've come so far. You've defied convergence. The Steins Gate is within your reach. Don't falter at the final step.": "okabe_defaultstare.png",
			"The first D-Mail is located. Deleting this is our first real shot at changing things back. Ready?": "daru_defaultstare.png",

			// FINAL TIER DIALOGUES
			"This time... this time for sure! I will deceive the world! Your streak is the proof that the impossible can be done!": "okabe_smirk2.png",
			"The world can be deceived. And this is the choice... of Steins Gate! Our shared choice!": "okabe_smirk.png",
			"The divergence meter... it's changing... 1... 1.048596... Look at what you've accomplished. We've reached the Steins Gate worldline!": "okabe_smirk2.png",
			"You could say that. My name is Okabe Rintaro. And this... this is our victory. Thank you for everything. El. Psy. Kongroo.": "okabe_smirk.png"
		};

        const timelines = {
            alpha: [
                { name: "Chaos-Theory Homeostasis", value: 0.571046 },
                { name: "Butterfly Effect's Divergence", value: 0.571024 },
                { name: "Metaphysical Necrosis", value: 0.523299 },
                { name: "Interpreter Rendezvous", value: 0.456903 },
                { name: "Made in Complex", value: 0.337187 },
                { name: "Fractal Androgyne", value: 0.409420 },
                { name: "Dogma in Event Horizon", value: 0.409431 }
            ],
            beta: [
                { name: "Gehenna's Stigma", value: 1.129848 },
                { name: "Promised Rinascimento", value: 1.129954 },
                { name: "Vega and Altair", value: 1.130205 },
                { name: "Milky-way Crossing", value: 1.130211 },
                { name: "Arc-light of Infinity", value: 1.130426 }
            ]
        };

        const presets = {
            authentic: {
                flickerSpeed: 17, flickerDuration: 35, flickerDesync: 300, flickerSmoothness: 4,
                meterSize: 130, soundLeadMs: 500, matchFlickerToSound: true
            },
            smooth: {
                flickerSpeed: 25, flickerDuration: 25, flickerDesync: 150, flickerSmoothness: 5,
                meterSize: 150, soundLeadMs: 400, matchFlickerToSound: true
            },
            minimal: {
                flickerSpeed: 50, flickerDuration: 15, flickerDesync: 100, flickerSmoothness: 2,
                meterSize: 100, soundLeadMs: 300, matchFlickerToSound: false
            },
            cinematic: {
                flickerSpeed: 15, flickerDuration: 40, flickerDesync: 400, flickerSmoothness: 4,
                meterSize: 160, soundLeadMs: 600, matchFlickerToSound: true
            }
        };

        let streakCount = 0;
        let isFlickering = false;
        let flickerStopTimes = [];
        let unusedDialogues = {};
        let currentDialogueTab = 'intro';

        // AMADEUS-style initialization animation
        function runInitialization() {
            if (!config.initAnimation) {
                document.getElementById('initializationOverlay').classList.add('hidden');
                return;
            }

            const overlay = document.getElementById('initializationOverlay');
            const progressFill = document.getElementById('initProgressFill');
            const status = document.getElementById('initStatus');
            
            const steps = [
                'Loading visual novel engine...',
                'Initializing divergence calculator...',
                'Connecting to worldline database...',
                'Loading character sprites...',
                'Synchronizing timeline data...',
                'SYSTEM READY'
            ];
            
            let currentStep = 0;
            
            function nextStep() {
                if (currentStep < steps.length) {
                    status.textContent = steps[currentStep];
                    progressFill.style.width = `${((currentStep + 1) / steps.length) * 100}%`;
                    
                    setTimeout(() => {
                        currentStep++;
                        if (currentStep < steps.length) {
                            nextStep();
                        } else {
                            setTimeout(() => {
                                overlay.classList.add('hidden');
                            }, 500);
                        }
                    }, 800);
                }
            }
            
            setTimeout(nextStep, 500);
        }

        // Enhanced particle system
        function createParticles() {
            if (!config.particleEffects) {
                document.getElementById('particles').innerHTML = '';
                return;
            }

            const particlesContainer = document.getElementById('particles');
            particlesContainer.innerHTML = '';
            
            for (let i = 0; i < 15; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 8 + 's';
                particle.style.animationDuration = (8 + Math.random() * 4) + 's';
                particlesContainer.appendChild(particle);
            }
        }

        // Check for background image and apply it
        function checkAndApplyBackground() {
            const img = new Image();
            img.onload = function() {
                document.getElementById('mainContainer').classList.add('has-background');
                if (!config.backgroundGlow) {
                    updateBackgroundGlow();
                }
            };
            img.onerror = function() {
                document.getElementById('mainContainer').classList.remove('has-background');
            };
            img.src = 'background.png';
        }

        // Update background glow
        function updateBackgroundGlow() {
            const glowOverlay = document.getElementById('backgroundGlowOverlay');
            if (glowOverlay) {
                if (config.backgroundGlow) {
                    glowOverlay.classList.add('active');
                } else {
                    glowOverlay.classList.remove('active');
                }
            }
        }

        // Update visual effects
        function updateVisualEffects() {
            const scanningLines = document.getElementById('scanningLines');
            scanningLines.style.display = config.scanningLines ? 'block' : 'none';
            
            createParticles();
        }

        // Update CMD status text positioning and sizing
        function updateCmdStatusPositioning() {
            const routeElement = document.getElementById('cmdStatusRoute');
            const worldlineElement = document.getElementById('cmdStatusWorldline');
            const progressElement = document.getElementById('cmdStatusProgress');

            if (routeElement) {
                routeElement.style.left = `${config.routeHorizontal}px`;
                routeElement.style.top = `${config.routeVertical}px`;
                routeElement.style.fontSize = `${config.routeSize}px`;
            }

            if (worldlineElement) {
                worldlineElement.style.right = `${config.worldlineHorizontal}px`;
                worldlineElement.style.top = `${config.worldlineVertical}px`;
                worldlineElement.style.fontSize = `${config.worldlineSize}px`;
            }

            if (progressElement) {
                progressElement.style.right = `${config.progressHorizontal}px`;
                progressElement.style.bottom = `${config.progressVertical}px`;
                progressElement.style.fontSize = `${config.progressSize}px`;
            }
        }

        // Update sprite vertical offset
        function updateSpriteOffset() {
            const sprite = document.getElementById('characterSprite');
            if (sprite) {
                sprite.style.bottom = `${config.spriteOffset}px`;
            }
        }

        // Update divergence meter positioning
        function updateMeterPosition() {
            const display = document.getElementById('divergenceDisplay');
            if (display) {
                display.style.transform = `translate(${config.meterHorizontal}px, ${config.meterVertical}px)`;
            }
        }

        // Update dialogue line spacing
        function updateDialogueLineSpacing() {
            const textContainer = document.querySelector('.dialogue-text-container');
            if (textContainer) {
                textContainer.style.lineHeight = config.dialogueLineSpacing;
            }
        }

        // Character sprite system functions
        function analyzeDialogueEmotion(dialogue, character) {
            const spriteName = dialogueToSprite?.[dialogue.trim()];
            if (spriteName) {
                return spriteName;
            }
            
            const charName = character.toLowerCase();
            const nameMapping = {
                'amadeus kurisu': 'amadeus',
                'future okabe': 'futureokabe',
                'narrator': null
            };
            const mappedChar = nameMapping[charName] || charName;
            
            if (mappedChar && CHARACTER_DIMENSIONS[mappedChar]) {
                return `${mappedChar}_defaultstare.png`;
            }
            
            return null;
        }

		function getCharacterSprite(character, dialogue) {
			const spritePath = analyzeDialogueEmotion(dialogue, character);
			if (spritePath) {
				return `sprites/${config.dialogueTimeline}/${spritePath}`;
			}
			return null;
		}

        function updateCharacterSprite(character, dialogue) {
            if (!config.enableSprites || !character) return;
            
            const spritePath = getCharacterSprite(character, dialogue);
            const spriteElement = document.getElementById('characterSprite');
            const dialogueBox = document.getElementById('dialogueBox');
            
            if (!spriteElement || !dialogueBox) return;
            
            if (spritePath && character.toLowerCase() !== 'narrator') {
                dialogueBox.classList.add('with-sprites');
                
                const charName = character.toLowerCase();
                const nameMapping = {
                    'amadeus kurisu': 'amadeus',
                    'future okabe': 'futureokabe'
                };
                const mappedChar = nameMapping[charName] || charName;
				const timeline = config.dialogueTimeline; // 'alpha' or 'beta'
				let dimensions = CHARACTER_DIMENSIONS[mappedChar] && CHARACTER_DIMENSIONS[mappedChar][timeline];

				if (!dimensions && CHARACTER_DIMENSIONS[mappedChar]) {
					// fallback to alpha if beta data is missing
					dimensions = CHARACTER_DIMENSIONS[mappedChar]['alpha'];
				}

				if (dimensions) {
					const scaleWidth = 250 / dimensions.width;
					const scaleHeight = 300 / dimensions.height;
					const scale = Math.min(scaleWidth, scaleHeight, 1);

					spriteElement.style.width = `${dimensions.width * scale}px`;
					spriteElement.style.height = `${dimensions.height * scale}px`;
				}
                
                spriteElement.src = spritePath;
                spriteElement.style.display = 'block';
                spriteElement.style.bottom = `${config.spriteOffset}px`;
                
				spriteElement.onerror = () => {
					const fallbackPath = `sprites/${config.dialogueTimeline}/${mappedChar}_defaultstare.png`;
					if (spriteElement.src !== fallbackPath) {
						spriteElement.src = fallbackPath;
					} else {
						spriteElement.style.display = 'none';
						dialogueBox.classList.remove('with-sprites');
					}
				};
                
                setTimeout(() => {
                    spriteElement.classList.add('visible');
                }, 100);
            } else {
                spriteElement.classList.remove('visible');
                spriteElement.style.display = 'none';
                dialogueBox.classList.remove('with-sprites');
            }
        }

        // Switch dialogue editor tabs
        function switchDialogueTab(tab) {
            document.querySelectorAll('.dialogue-content').forEach(content => content.classList.remove('active'));
            document.querySelectorAll('.dialogue-tab').forEach(tabButton => tabButton.classList.remove('active'));
            document.getElementById(`dialogue-${tab}`).classList.add('active');
            event.target.classList.add('active');
            currentDialogueTab = tab;
        }

        // Parse custom dialogue from textarea
        function parseCustomDialogue(text) {
            if (!text.trim()) return [];
            return text.split('\n').map(line => line.trim()).filter(line => line.length > 0 && line.includes(':'));
        }

        // Get active dialogues (custom or default)
        function getActiveDialogues(tier) {
            const customDialogues = config.customDialogues[tier];
            if (customDialogues && customDialogues.length > 0) {
                return customDialogues;
            }
            return allDialogues?.[config.dialogueTimeline]?.[tier] || [];
        }

        // Initialize audio
        function initializeAudio() {
            try {
                streakSound = document.getElementById('streakSound');
                if (streakSound) {
                    streakSound.volume = config.soundVolume / 100;
                    streakSound.load();
                }
            } catch (error) { console.warn('Audio initialization failed:', error); }
        }

        // Play streak sound
        function playStreakSound() {
            try {
                if (config.soundEnabled && streakSound) {
                    streakSound.currentTime = 0;
                    streakSound.volume = config.soundVolume / 100;
                    const playPromise = streakSound.play();
                    if (playPromise !== undefined) {
                        playPromise.catch(error => { console.warn('Audio playback failed:', error); });
                    }
                }
            } catch (error) { console.warn('Failed to play streak sound:', error); }
        }

        // Play sound then flicker with proper timing
        function playSoundThenFlicker(callback) {
            playStreakSound();
            const originalDuration = config.flickerDuration;
            let actualDuration = originalDuration;
            if (config.matchFlickerToSound && streakSound?.duration && !isNaN(streakSound.duration)) {
                const remainingMs = Math.max(0, (streakSound.duration * 1000) - config.soundLeadMs);
                const calculatedFrames = Math.ceil(remainingMs / config.flickerSpeed);
                if (calculatedFrames >= 10 && calculatedFrames <= 100 && calculatedFrames > originalDuration) {
                    actualDuration = calculatedFrames;
                }
            }
            setTimeout(() => flickerAnimation(callback, actualDuration), config.soundLeadMs);
        }

        // Update only the value displays without applying changes
        function updateValueDisplays() {
            try {
                const valueUpdates = {
                    'meterSizeInput': { display: 'meterSizeValue', suffix: 'px' },
                    'meterHorizontalInput': { display: 'meterHorizontalValue', suffix: 'px' },
                    'meterVerticalInput': { display: 'meterVerticalValue', suffix: 'px' },
                    'spriteOffsetInput': { display: 'spriteOffsetValue', suffix: 'px' },
                    'routeHorizontalInput': { display: 'routeHorizontalValue', suffix: 'px' },
                    'routeVerticalInput': { display: 'routeVerticalValue', suffix: 'px' },
                    'routeSizeInput': { display: 'routeSizeValue', suffix: 'px' },
                    'worldlineHorizontalInput': { display: 'worldlineHorizontalValue', suffix: 'px' },
                    'worldlineVerticalInput': { display: 'worldlineVerticalValue', suffix: 'px' },
                    'worldlineSizeInput': { display: 'worldlineSizeValue', suffix: 'px' },
                    'progressSizeInput': { display: 'progressSizeValue', suffix: 'px' },
                    'progressHorizontalInput': { display: 'progressHorizontalValue', suffix: 'px' },
                    'progressVerticalInput': { display: 'progressVerticalValue', suffix: 'px' },
                    'dialogueLineSpacingInput': { display: 'dialogueLineSpacingValue', suffix: '' },
                    'soundVolumeInput': { display: 'soundVolumeValue', suffix: '%' },
                    'soundLeadInput': { display: 'soundLeadValue', suffix: 'ms' },
                    'flickerSpeedInput': { display: 'flickerSpeedValue', suffix: 'ms' },
                    'flickerDurationInput': { display: 'flickerDurationValue', suffix: ' frames' },
                    'flickerDesyncInput': { display: 'flickerDesyncValue', suffix: 'ms' },
                    'flickerSmoothInput': { display: 'flickerSmoothValue', suffix: '' }
                };
                Object.entries(valueUpdates).forEach(([inputId, displayInfo]) => {
                    const input = document.getElementById(inputId);
                    const display = document.getElementById(displayInfo.display);
                    if (input && display) {
                        display.textContent = input.value + displayInfo.suffix;
                    }
                });
            } catch (error) { console.error('Error updating value displays:', error); }
        }

        // Save all settings WITH PROGRESS PRESERVATION
        function saveSettings() {
            try {
                // Store current streak before saving
                const currentStreak = streakCount;
                
                const inputs = {
                    'meterSizeInput': 'meterSize', 'meterHorizontalInput': 'meterHorizontal', 'meterVerticalInput': 'meterVertical',
                    'spriteOffsetInput': 'spriteOffset', 'routeHorizontalInput': 'routeHorizontal', 'routeVerticalInput': 'routeVertical',
                    'routeSizeInput': 'routeSize', 'worldlineHorizontalInput': 'worldlineHorizontal', 'worldlineVerticalInput': 'worldlineVertical',
                    'worldlineSizeInput': 'worldlineSize', 'progressSizeInput': 'progressSize', 
                    'progressHorizontalInput': 'progressHorizontal', 'progressVerticalInput': 'progressVertical',
                    'dialogueLineSpacingInput': 'dialogueLineSpacing',
                    'soundVolumeInput': 'soundVolume', 'soundLeadInput': 'soundLeadMs', 'flickerSpeedInput': 'flickerSpeed',
                    'flickerDurationInput': 'flickerDuration', 'flickerDesyncInput': 'flickerDesync',
                    'flickerSmoothInput': 'flickerSmoothness', 'totalDaysInput': 'totalDays'
                };
                const checkboxes = {
                    'soundEnabledInput': 'soundEnabled', 'matchFlickerInput': 'matchFlickerToSound',
                    'flickerEnabledInput': 'flickerEnabled', 'autoHideDialogue': 'autoHideDialogue',
                    'enableSprites': 'enableSprites', 'backgroundGlowInput': 'backgroundGlow',
                    'initAnimationInput': 'initAnimation', 'scanningLinesInput': 'scanningLines',
                    'particleEffectsInput': 'particleEffects'
                };
                const selects = {
                    'timelineSelect': 'startValue', 'dialoguePositionSelect': 'dialoguePosition',
                    'dialogueTimelineSelect': 'dialogueTimeline'
                };
                
                Object.entries(inputs).forEach(([inputId, configKey]) => {
                    const input = document.getElementById(inputId);
                    if (input) config[configKey] = parseFloat(input.value) || config[configKey];
                });
                Object.entries(checkboxes).forEach(([inputId, configKey]) => {
                    const input = document.getElementById(inputId);
                    if (input) config[configKey] = input.checked;
                });
                
                // Special handling for timeline and totalDays - these reset progress
                const timelineInput = document.getElementById('timelineSelect');
                const totalDaysInput = document.getElementById('totalDaysInput');
                
                let shouldResetProgress = false;
                if (timelineInput && parseFloat(timelineInput.value) !== config.startValue) {
                    config.startValue = parseFloat(timelineInput.value);
                    shouldResetProgress = true;
                }
                if (totalDaysInput && parseInt(totalDaysInput.value) !== config.totalDays) {
                    config.totalDays = parseInt(totalDaysInput.value);
                    shouldResetProgress = true;
                }
                
                // Handle other selects that don't reset progress
                const dialoguePositionInput = document.getElementById('dialoguePositionSelect');
                const dialogueTimelineInput = document.getElementById('dialogueTimelineSelect');
                if (dialoguePositionInput) config.dialoguePosition = dialoguePositionInput.value;
                if (dialogueTimelineInput) config.dialogueTimeline = dialogueTimelineInput.value;
                
                const dialogueInputs = {
                    'customDialogueIntro': 'intro', 'customDialogueEarly': 'early', 'customDialogueMid': 'mid',
                    'customDialogueLate': 'late', 'customDialogueFinal': 'final'
                };
                Object.entries(dialogueInputs).forEach(([inputId, tier]) => {
                    const textarea = document.getElementById(inputId);
                    if (textarea) config.customDialogues[tier] = parseCustomDialogue(textarea.value);
                });
                
                // Reset streak ONLY if timeline or totalDays changed
                if (shouldResetProgress) {
                    streakCount = 0;
                } else {
                    streakCount = currentStreak; // Preserve progress for all other settings
                }
                
                initializeDialogues();
                updateDialoguePosition();
                updateDialogueLineSpacing();
                updateSpriteOffset();
                updateMeterPosition();
                updateCmdStatusPositioning();
                updateBackgroundGlow();
                updateVisualEffects();
                checkAndApplyBackground();
                if (streakSound) streakSound.volume = config.soundVolume / 100;
                updateDisplay();
                localStorage.setItem('steinsGateStreak', JSON.stringify({ streakCount, config }));
                
                if (shouldResetProgress) {
                    showTooltip('Settings saved! Progress reset due to timeline/days change. ⚠️', 3000);
                } else {
                    showTooltip('Settings saved! Progress preserved. ✅', 2000);
                }
                
            } catch (error) {
                console.error('Error saving settings:', error);
                showTooltip('Error saving settings! ❌', 2000);
            }
        }

        // Initialize dialogue pools
        function initializeDialogues() {
            if (allDialogues) {
                Object.keys(allDialogues.alpha).forEach(key => {
                    const activeDialogues = getActiveDialogues(key);
                    unusedDialogues[key] = [...activeDialogues];
                });
            }
        }

        // Populate timeline dropdown
        function populateTimelines() {
            try {
                const select = document.getElementById('timelineSelect');
                if (!select) return;
                select.innerHTML = '';
                [...timelines.alpha, ...timelines.beta].forEach(line => {
                    const option = document.createElement('option');
                    option.value = line.value;
                    option.textContent = `${line.name} (${line.value})`;
                    select.appendChild(option);
                });
            } catch (error) { console.error('Error populating timelines:', error); }
        }

        // Update dialogue position
        function updateDialoguePosition() {
            try {
                const dialogueBox = document.getElementById('dialogueBox');
                if (dialogueBox) {
                    dialogueBox.className = dialogueBox.className.replace(/position-\S+/g, '');
                    dialogueBox.classList.add(`position-${config.dialoguePosition}`);
                }
            } catch (error) { console.error('Error updating dialogue position:', error); }
        }

        // Load saved data
        function loadData() {
            try {
                const saved = localStorage.getItem('steinsGateStreak');
                if (saved) {
                    const data = JSON.parse(saved);
                    streakCount = data.streakCount || 0;
                    config = { ...config, ...data.config, customDialogues: { ...config.customDialogues, ...(data.config?.customDialogues || {}) } };
                }
            } catch (error) {
                console.error('Error loading data:', error);
                streakCount = 0;
            }
        }

        // Save data
        function saveData() {
            try {
                localStorage.setItem('steinsGateStreak', JSON.stringify({ streakCount, config }));
            } catch (error) { console.error('Error saving data:', error); }
        }

        // Calculate current divergence
        function getCurrentDivergence() {
            const start = config.startValue;
            const target = STEINS_GATE_TARGET;
            const progress = config.totalDays > 0 ? streakCount / config.totalDays : 0;
            return (start > target) ? start - (start - target) * Math.min(progress, 1) : start + (target - start) * Math.min(progress, 1);
        }

        // Format divergence number
        function formatDivergence(value) { return value.toFixed(6); }

        // Update display
        function updateDisplay(overrideString = null) {
            try {
                const divergence = getCurrentDivergence();
                const formattedDivergence = overrideString || formatDivergence(divergence);
                const displayContainer = document.getElementById('divergenceDisplay');
                if (!displayContainer) return;
                displayContainer.innerHTML = '';
                for (const char of formattedDivergence) {
                    const img = document.createElement('img');
                    img.src = (char === '.') ? 'dot.png' : `${char}.png`;
                    img.style.height = `${config.meterSize}px`;
                    img.onerror = () => {
                        const fallback = document.createElement('div');
                        fallback.className = 'fallback-digit';
                        fallback.textContent = char;
                        fallback.style.height = `${config.meterSize}px`;
                        fallback.style.lineHeight = `${config.meterSize}px`;
                        fallback.style.fontSize = (char === '.') ? `${config.meterSize * 0.37}px` : `${config.meterSize * 0.37}px`;
                        displayContainer.replaceChild(fallback, img);
                    };
                    displayContainer.appendChild(img);
                }
                if (!overrideString) {
                    updateInfoPanel();
                    saveData();
                }
            } catch (error) {
                console.error('Error updating display:', error);
                const displayContainer = document.getElementById('divergenceDisplay');
                if (displayContainer) displayContainer.innerHTML = '<div class="fallback-digit">E</div><div class="fallback-digit">R</div><div class="fallback-digit">R</div>';
            }
        }

        // Updated info panel for CMD style display
        function updateInfoPanel() {
            try {
                const divergence = getCurrentDivergence();
                const currentLine = [...timelines.alpha, ...timelines.beta].find(l => l.value === config.startValue) || { name: "Unknown" };
                
                // Update CMD status text elements
                document.getElementById('cmdStatusRoute').textContent = `Route: ${currentLine.name}`;
                document.getElementById('cmdStatusWorldline').textContent = `Worldline: ${formatDivergence(divergence)} | Target: 1.048596`;
                document.getElementById('cmdStatusProgress').textContent = `Progress: ${streakCount}/${config.totalDays} Days`;
                
            } catch (error) { console.error('Error updating info panel:', error); }
        }

        // Flicker animation
        function flickerAnimation(callback, overrideDuration = null) {
            if (isFlickering || !config.flickerEnabled) {
                if (callback) callback();
                return;
            }
            isFlickering = true;
            const target = formatDivergence(getCurrentDivergence());
            const len = target.length;
            const duration = overrideDuration || config.flickerDuration;
            const baseTime = duration * config.flickerSpeed;
            const maxDesync = config.flickerDesync;
            flickerStopTimes = [];
            for (let i = 0; i < len; i++) {
                if (target[i] === '.') {
                    flickerStopTimes.push(0);
                } else {
                    const waveOffset = (len - 1 - i) * config.flickerSpeed * config.flickerSmoothness;
                    const randomOffset = Math.random() * maxDesync;
                    flickerStopTimes.push(baseTime + waveOffset + randomOffset);
                }
            }
            let elapsed = 0;
            const digitHistory = new Array(len).fill(null).map(() => []);
            const availableDigits = new Array(len).fill(null).map(() => [0,1,2,3,4,5,6,7,8,9]);
            function step() {
                elapsed += config.flickerSpeed;
                let display = '';
                let allDone = true;
                for (let i = 0; i < len; i++) {
                    const ch = target[i];
                    if (ch === '.' || elapsed >= flickerStopTimes[i]) {
                        display += ch;
                    } else {
                        let newDigit;
                        if (availableDigits[i].length === 0) {
                            availableDigits[i] = [0,1,2,3,4,5,6,7,8,9];
                            if (digitHistory[i].length > 2) {
                                const recentDigits = digitHistory[i].slice(-2);
                                availableDigits[i] = availableDigits[i].filter(d => !recentDigits.includes(d));
                            }
                        }
                        const randomIndex = Math.floor(Math.random() * availableDigits[i].length);
                        newDigit = availableDigits[i][randomIndex];
                        availableDigits[i] = availableDigits[i].filter(d => d !== newDigit);
                        digitHistory[i].push(newDigit);
                        if (digitHistory[i].length > 3) digitHistory[i].shift();
                        display += newDigit.toString();
                        allDone = false;
                    }
                }
				// Pad display string to target length just in case (8 characters, including '.')
				while (display.length < len) {
					display += '0'; // or any digit, just not shorter
				}
				updateDisplay(display);
                if (!allDone) {
                    setTimeout(step, config.flickerSpeed);
                } else {
                    isFlickering = false;
                    setTimeout(() => { updateDisplay(); if (callback) callback(); }, config.flickerSpeed);
                }
            }
            step();
        }

        // Show dialogue with sprites
        function showDialogue() {
            try {
                const progress = config.totalDays > 0 ? streakCount / config.totalDays : 0;
                let tier;
                if (progress >= 0.95) tier = 'final';
                else if (progress >= 0.61) tier = 'late';
                else if (progress >= 0.31) tier = 'mid';
                else if (progress >= 0.11) tier = 'early';
                else tier = 'intro';

                const activeDialogues = getActiveDialogues(tier);
                if (!activeDialogues || activeDialogues.length === 0) return;

                if (!unusedDialogues[tier] || unusedDialogues[tier].length === 0) {
                    unusedDialogues[tier] = [...activeDialogues];
                }
                const dialogueIndex = Math.floor(Math.random() * unusedDialogues[tier].length);
                const fullDialogue = unusedDialogues[tier].splice(dialogueIndex, 1)[0];
                
                let char, line;
                if (typeof fullDialogue === 'object' && fullDialogue.char && fullDialogue.line) {
                    char = fullDialogue.char;
                    line = fullDialogue.line;
                } else {
                    [char, line] = fullDialogue.split(': ');
                }

                const box = document.getElementById('dialogueBox');
                if (box && char && line) {
                    const cleanLine = line.trim().replace(/^['"]|['"]$/g, '');
                    
                    const textContainer = box.querySelector('.dialogue-text-container');
                    if (textContainer) {
                        textContainer.innerHTML = `<span class="dialogue-char">${char}: </span>${cleanLine}`;
                        textContainer.style.lineHeight = config.dialogueLineSpacing;
                    } else {
                        box.innerHTML = `<div class="dialogue-text-container" style="line-height: ${config.dialogueLineSpacing};"><span class="dialogue-char">${char}: </span>${cleanLine}</div><img class="character-sprite" id="characterSprite" style="display: none;" alt="Character Sprite">`;
                    }
                    
                    updateCharacterSprite(char, cleanLine);
                    
                    box.classList.add('visible');
                    const hideDelay = config.autoHideDialogue ? 5000 : 10000;
                    setTimeout(() => { 
                        box.classList.remove('visible');
                        const spriteElement = document.getElementById('characterSprite');
                        if (spriteElement) {
                            spriteElement.classList.remove('visible');
                        }
                    }, hideDelay);
                }
            } catch (error) { console.error('Error showing dialogue:', error); }
        }

        // Show tooltip
        function showTooltip(message, duration = 3000) {
            const tooltip = document.getElementById('tooltip');
            if (tooltip) {
                tooltip.textContent = message;
                tooltip.classList.add('visible');
                setTimeout(() => tooltip.classList.remove('visible'), duration);
            }
        }

        // Show shortcuts help
        function showShortcutsHelp() {
            const helpText = `Keyboard Shortcuts:\n• W - Productive Day (+1)\n• S - Toggle Settings Panel\n• Ctrl+? - Show this help`;
            const helpBox = document.getElementById('dialogueBox');
            if (helpBox) {
                const textContainer = helpBox.querySelector('.dialogue-text-container');
                if (textContainer) {
                    textContainer.innerHTML = `<div class="help-text">${helpText}</div>`;
                }
                helpBox.classList.add('visible');
                setTimeout(() => helpBox.classList.remove('visible'), 8000);
            }
        }

        // Apply preset
        function applyPreset(presetName) {
            const preset = presets[presetName];
            if (!preset) return;
            Object.assign(config, preset);
            syncUIWithConfig();
            showTooltip(`${presetName.charAt(0).toUpperCase() + presetName.slice(1)} preset loaded! Click "Save Settings" to apply.`);
        }

        // Sync UI inputs with current config values
        function syncUIWithConfig() {
            try {
                const inputs = {
                    'meterSizeInput': config.meterSize, 'meterHorizontalInput': config.meterHorizontal, 'meterVerticalInput': config.meterVertical,
                    'spriteOffsetInput': config.spriteOffset, 'routeHorizontalInput': config.routeHorizontal, 'routeVerticalInput': config.routeVertical,
                    'routeSizeInput': config.routeSize, 'worldlineHorizontalInput': config.worldlineHorizontal, 'worldlineVerticalInput': config.worldlineVertical,
                    'worldlineSizeInput': config.worldlineSize, 'progressSizeInput': config.progressSize,
                    'progressHorizontalInput': config.progressHorizontal, 'progressVerticalInput': config.progressVertical,
                    'dialogueLineSpacingInput': config.dialogueLineSpacing,
                    'soundVolumeInput': config.soundVolume, 'soundLeadInput': config.soundLeadMs, 'flickerSpeedInput': config.flickerSpeed,
                    'flickerDurationInput': config.flickerDuration, 'flickerDesyncInput': config.flickerDesync,
                    'flickerSmoothInput': config.flickerSmoothness, 'totalDaysInput': config.totalDays
                };
                const checkboxes = {
                    'soundEnabledInput': config.soundEnabled, 'matchFlickerInput': config.matchFlickerToSound,
                    'flickerEnabledInput': config.flickerEnabled, 'autoHideDialogue': config.autoHideDialogue,
                    'enableSprites': config.enableSprites, 'backgroundGlowInput': config.backgroundGlow,
                    'initAnimationInput': config.initAnimation, 'scanningLinesInput': config.scanningLines,
                    'particleEffectsInput': config.particleEffects
                };
                const selects = {
                    'timelineSelect': config.startValue, 'dialoguePositionSelect': config.dialoguePosition,
                    'dialogueTimelineSelect': config.dialogueTimeline
                };
                Object.entries(inputs).forEach(([inputId, value]) => {
                    const input = document.getElementById(inputId);
                    if (input) input.value = value;
                });
                Object.entries(checkboxes).forEach(([inputId, value]) => {
                    const input = document.getElementById(inputId);
                    if (input) input.checked = value;
                });
                Object.entries(selects).forEach(([inputId, value]) => {
                    const input = document.getElementById(inputId);
                    if (input) input.value = value;
                });
                const dialogueInputs = {
                    'customDialogueIntro': 'intro', 'customDialogueEarly': 'early', 'customDialogueMid': 'mid',
                    'customDialogueLate': 'late', 'customDialogueFinal': 'final'
                };
                Object.entries(dialogueInputs).forEach(([inputId, tier]) => {
                    const textarea = document.getElementById(inputId);
                    if (textarea && config.customDialogues[tier]) {
                        textarea.value = config.customDialogues[tier].join('\n');
                    }
                });
                updateValueDisplays();
            } catch (error) { console.error('Error syncing UI with config:', error); }
        }

        // User actions
        function incrementStreak() {
            if (isFlickering) return;
            streakCount++;
            playSoundThenFlicker(() => {
                showDialogue();
                if (streakCount >= config.totalDays) {
                    showTooltip('Congratulations! You\'ve reached the Steins Gate worldline! El Psy Kongroo...', 5000);
                }
            });
        }

        function resetStreak() {
            if (isFlickering) return;
            const attractorFields = ['alpha', 'beta'];
            const randomField = attractorFields[Math.floor(Math.random() * attractorFields.length)];
            const pool = randomField === 'beta' ? timelines.beta : timelines.alpha;
            const randomLine = pool[Math.floor(Math.random() * pool.length)];
            config.startValue = randomLine.value;
			config.dialogueTimeline = randomField;
            streakCount = 0;
            playSoundThenFlicker();
            syncUIWithConfig();
            showTooltip(`Reset to ${randomField.charAt(0).toUpperCase() + randomField.slice(1)} attractor field: ${randomLine.name}`);
        }

        function toggleSettings() {
            try {
                const drawer = document.getElementById('settingsDrawer');
                if (drawer) drawer.classList.toggle('active');
            } catch (error) { console.error('Error toggling settings:', error); }
        }

        // Keyboard event handler
        function handleKeydown(e) {
            if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'SELECT' || document.activeElement.tagName === 'TEXTAREA') return;
            const keyActions = { 
                'w': incrementStreak, 's': toggleSettings,
                '?': () => e.ctrlKey && showShortcutsHelp()
            };
            const action = keyActions[e.key.toLowerCase()];
            if (action) {
                e.preventDefault();
                action();
            }
        }

        // Initialize everything
        function initialize() {
            try {
                console.log('Initializing Steins;Gate Divergence Meter...');
                initializeAudio();
                populateTimelines();
                loadData();
                initializeDialogues();
                syncUIWithConfig();
                updateDialogueLineSpacing();
                updateSpriteOffset();
                updateMeterPosition();
                updateCmdStatusPositioning();
                updateBackgroundGlow();
                updateVisualEffects();
                checkAndApplyBackground();
                updateDisplay();
                runInitialization();
                setInterval(saveData, 30000);
                console.log('Initialization complete!');
            } catch (error) {
                console.error('Error during initialization:', error);
                updateDisplay();
            }
        }

        document.addEventListener('keydown', handleKeydown);
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
